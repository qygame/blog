<!doctype html><html lang=en dir=ltr><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="gate server "><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#343a40"><meta name=color-scheme content="light dark"><meta property="og:url" content="https://qygame.github.io/blog/docs/server/gate/"><meta property="og:site_name" content="QYGame"><meta property="og:title" content="gate"><meta property="og:description" content="gate server"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="docs"><meta property="article:published_time" content="2025-10-01T18:04:00+00:00"><meta property="article:modified_time" content="2025-10-02T11:40:21+00:00"><title>gate | QYGame</title><link rel=icon href=/blog/favicon.png><link rel=manifest href=/blog/manifest.json><link rel=canonical href=https://qygame.github.io/blog/docs/server/gate/><link rel=stylesheet href=/blog/book.min.e456d10aed65d3bbdca94d70c236a8aa850b8de9fd31e4073ed44adec0702035.css integrity="sha256-5FbRCu1l07vcqU1wwjaoqoULjen9MeQHPtRK3sBwIDU=" crossorigin=anonymous><script defer src=/blog/fuse.min.js></script><script defer src=/blog/en.search.min.a97f57dabb194fe3b562b118dd17c8d2e15175f97d9ab35a3f1a0b68f7742805.js integrity="sha256-qX9X2rsZT+O1YrEY3RfI0uFRdfl9mrNaPxoLaPd0KAU=" crossorigin=anonymous></script></head><body dir=ltr class="book-kind-page book-type-docs"><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/blog/><span>QYGame</span></a></h2><div class="book-search hidden"><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><script>document.querySelector(".book-search").classList.remove("hidden")</script><ul><li><input type=checkbox id=section-34398fe48a8d5915c36c0eb2b8916210 class=toggle>
<label for=section-34398fe48a8d5915c36c0eb2b8916210 class=flex><a role=button>client</a>
<img src=/blog/icons/chevron-right.svg class=book-icon></label><ul><li><input type=checkbox id=section-2e9d04bfd4dd4fc219af19418e015aab class=toggle>
<label for=section-2e9d04bfd4dd4fc219af19418e015aab class=flex><a role=button>unity, android, ios基础</a>
<img src=/blog/icons/chevron-right.svg class=book-icon></label><ul><li><a href=/blog/docs/client/base/unity/>unity</a></li><li><a href=/blog/docs/client/base/android/>Android</a></li></ul></li><li><a href=/blog/docs/client/env_init/>环境搭建</a></li><li><input type=checkbox id=section-997f07e84d31c017a773b9faf3512cbe class=toggle>
<label for=section-997f07e84d31c017a773b9faf3512cbe class=flex><a role=button>打包流程</a>
<img src=/blog/icons/chevron-right.svg class=book-icon></label><ul><li><a href=/blog/docs/client/build/build/>unity打包注意事项</a></li><li><a href=/blog/docs/client/build/build_apple/>苹果打包流程</a></li></ul></li><li><input type=checkbox id=section-d96bd7ee4333805fbd11f9f25c8fa174 class=toggle>
<label for=section-d96bd7ee4333805fbd11f9f25c8fa174 class=flex><a role=button>sdk介绍</a>
<img src=/blog/icons/chevron-right.svg class=book-icon></label><ul><li><a href=/blog/docs/client/sdk/bdframework/>BDFramework</a></li><li><a href=/blog/docs/client/sdk/sharesdk/>ShareSDK</a></li></ul></li><li><a href=/blog/docs/client/subgame/>子游戏</a></li><li><a href=/blog/docs/client/client/>client</a></li></ul></li><li><input type=checkbox id=section-d15f507e6e1a7624bc54d6a8a1d45016 class=toggle checked>
<label for=section-d15f507e6e1a7624bc54d6a8a1d45016 class=flex><a role=button>server</a>
<img src=/blog/icons/chevron-right.svg class=book-icon></label><ul><li><a href=/blog/docs/server/server/>约定俗称</a></li><li><a href=/blog/docs/server/redis/>redis</a></li><li><a href=/blog/docs/server/gate/ class=active>gate</a></li><li><a href=/blog/docs/server/db/>db</a></li><li><a href=/blog/docs/server/room/>room</a></li><li><a href=/blog/docs/server/subgame/>subgame</a></li></ul></li></ul></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/blog/icons/menu.svg class=book-icon alt=Menu></label><h3>gate</h3><label for=toc-control><img src=/blog/icons/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#server-gate>server-gate</a><ul><li><a href=#logon>logon</a></li><li><a href=#game>game</a></li><li><a href=#center>center</a></li><li><a href=#server-match><span class="org-todo todo TODO">TODO</span> server–match</a></li><li><a href=#server-rank><span class="org-todo todo TODO">TODO</span> server–rank</a></li><li><a href=#server-task>server&ndash;task</a></li></ul></li></ul></nav></aside></header><article class="markdown book-article"><p>gate server<br></p><h2 id=server-gate>server-gate<a class=anchor href=#server-gate>#</a></h2><h3 id=logon>logon<a class=anchor href=#logon>#</a></h3><h4 id=重复登陆>重复登陆<a class=anchor href=#%e9%87%8d%e5%a4%8d%e7%99%bb%e9%99%86>#</a></h4><p><strong>在当前gateSvr中重复登陆</strong><br>auto player = player_manager.get(uid);<br>player.gatesvr_session != player.current_session 就认为是重复登陆<br></p><p><strong>在所有gateSvr中重复登陆</strong><br>redis中存在 key=gate_$uid, val=gatesvrid<br>redis.val != current_serverid 说明该uid正在其他gateSvr上. 认为重复登陆<br></p><p><strong>重复登陆处理</strong><br>在当前gateSvr中重复登陆, 可以直接关闭旧的连接<br>在其他gateSvr中重复登陆, 需要通过 ?? 通知对应的gateSvr, 关闭玩家连接<br></p><h4 id=断线重连>断线重连<a class=anchor href=#%e6%96%ad%e7%ba%bf%e9%87%8d%e8%bf%9e>#</a></h4><p><strong>判断依据</strong><br>玩家登陆的时候,<br>redis中存在 key=room_$uid, val=roomsvrid<br>gateSvr会向roomSvr确认玩家是否真的在roomSvr中,<br>如果roomSvr返回在, 则认为玩家是断线重连<br></p><p><strong>断线处理</strong><br></p><ol><li>gateSvr更新player的roomsvrid信息<br></li><li>通知client<br></li></ol><h3 id=game>game<a class=anchor href=#game>#</a></h3><p>房间信息查询<br>数据来源于roomSvr. roomSvr连接成功之后, 会主动推送<br></p><h4 id=数据格式>数据格式<a class=anchor href=#%e6%95%b0%e6%8d%ae%e6%a0%bc%e5%bc%8f>#</a></h4><p>房卡场 &ndash; 查询房间配置:<br>file: cfg_fk.hh<br>data: map&lt;kindid, rule_arry><br></p><p>金币场 &ndash; 查询金币场信息<br>file: cfg_gold.hh<br>data: map&lt;kindid, vector&lt;gold_msg>><br></p><p>roomSvr信息<br>file: server_manager<br>data:<br>map&lt;session, vec&lt;kind+level>><br>map&lt;vec&lt;kind+level>, session><br></p><p>保留roomSvr的意义:<br>如果roomSvr与gateSvr断开连接了, 那么就可以实时的更新3个data数据.<br>保证client那边看到的永远是可用的服务器<br></p><h3 id=center>center<a class=anchor href=#center>#</a></h3><p>路由clien &lt;->roomSvr<br></p><ul><li>client -> gate -> roomsvr<br>依据&lt;player, roomsvrid> &lt;x_session, roomsvrid>路由<br>不使用redis的room_$uid是因为redis承载量不够<br></li><li>roomsvr -> gate -> client<br>依据&lt;player, client_session>路由<br></li></ul><p>&lt;player, roomsvrid> 在player_manager中维护<br></p><ol><li>玩家登陆成功时候, 根据redis中room_$uid来确认<br></li><li>玩家在roomSvr中加入或退出的时候, roomSvr也会主动推送给gateSvr.<br></li></ol><p>&lt;x_session, roomsvrid> 在server_manager中维护<br></p><h4 id=对外接口>对外接口<a class=anchor href=#%e5%af%b9%e5%a4%96%e6%8e%a5%e5%8f%a3>#</a></h4><ul><li>SetRoomID(uid, roomsvrid)<br></li></ul><h3 id=server-match><span class="org-todo todo TODO">TODO</span> server&ndash;match<a class=anchor href=#server-match>#</a></h3><h4 id=设计理念>设计理念<a class=anchor href=#%e8%ae%be%e8%ae%a1%e7%90%86%e5%bf%b5>#</a></h4><p>matchSvr负责维护 {uid, score} 排行,<br>具体的数据是roomSvr通知的matchSvr<br></p><p>match没有必要把同排行的人放到一个roomSvr, 因此不需要指定roomSvr<br></p><h4 id=组织架构>组织架构<a class=anchor href=#%e7%bb%84%e7%bb%87%e6%9e%b6%e6%9e%84>#</a></h4><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>kind1  --  match-type 1  -- match 1 -- {对应一系列桌子}
</span></span><span style=display:flex><span>                         -- ....
</span></span><span style=display:flex><span>                         -- match N
</span></span><span style=display:flex><span>       --  ....
</span></span><span style=display:flex><span>       --  match-type N
</span></span><span style=display:flex><span>....
</span></span><span style=display:flex><span>kind N</span></span></code></pre></div><h4 id=流程>流程<a class=anchor href=#%e6%b5%81%e7%a8%8b>#</a></h4><ol><li>玩家申请加入某个比赛场match_type, 如果没有空的match, 则创建一个match, 放入玩家<br>设置其tableid为MATCH_TABLE, 防止进入其他桌子<br>如果玩家取消比赛, tableid重置为INVALID_TABLE<br>玩家掉线的时候, 如果还在比赛排队状态(tableid为MATCH_TABLE), 则按取消比赛处理<br></li><li>当match满足触发条件之后, 开始比赛<br>matchSvr把玩家分组, 并通知roomSvr创建桌子<br></li><li>roomSvr进行游戏, 当table大局结束的时候, 把数据(score)返回给matchSvr<br></li><li>matchSvr进行排序, 重新分组, 继续通知roomSvr开始游戏<br></li><li>循环直至比赛结束为止<br></li></ol><h4 id=依赖关系>依赖关系<a class=anchor href=#%e4%be%9d%e8%b5%96%e5%85%b3%e7%b3%bb>#</a></h4><p>依赖GameSvr, 需要GameSvr提供的GetRoomRule()接口<br></p><h4 id=缺陷>缺陷<a class=anchor href=#%e7%bc%ba%e9%99%b7>#</a></h4><p>有状态的, 需要后期改为无状态服务器<br></p><h4 id=配置文件>配置文件<a class=anchor href=#%e9%85%8d%e7%bd%ae%e6%96%87%e4%bb%b6>#</a></h4><p>配置文件放在subgames/kinid/kindid.match中<br></p><h3 id=server-rank><span class="org-todo todo TODO">TODO</span> server&ndash;rank<a class=anchor href=#server-rank>#</a></h3><h4 id=对外接口>对外接口<a class=anchor href=#%e5%af%b9%e5%a4%96%e6%8e%a5%e5%8f%a3>#</a></h4><ul><li>PushRank(ranktype, uid, score)<br></li></ul><h4 id=配置文件>配置文件<a class=anchor href=#%e9%85%8d%e7%bd%ae%e6%96%87%e4%bb%b6>#</a></h4><p><strong>配置文件放在database rank表</strong><br></p><table><thead><tr><th>id</th><th>rank_name</th><th>rank_desc</th><th>type</th><th>sortid</th><th>award</th><th>valid</th></tr></thead><tbody><tr><td>自增</td><td>名字</td><td>描述</td><td>类型(唯一标志)</td><td>优先级</td><td>奖励</td><td>是否开启</td></tr></tbody></table><h4 id=定时功能的设计>定时功能的设计<a class=anchor href=#%e5%ae%9a%e6%97%b6%e5%8a%9f%e8%83%bd%e7%9a%84%e8%ae%be%e8%ae%a1>#</a></h4><p>自定义定时操作<br>缺点非常明显, 如果Svr挂了, 那么可能会导致数据错乱<br>所以需要额外考虑svr挂掉的情况<br></p><h3 id=server-task>server&ndash;task<a class=anchor href=#server-task>#</a></h3><h4 id=对外接口>对外接口<a class=anchor href=#%e5%af%b9%e5%a4%96%e6%8e%a5%e5%8f%a3>#</a></h4><ul><li>PushTask(task_type, uid, score)<br></li></ul><h4 id=流程图>流程图<a class=anchor href=#%e6%b5%81%e7%a8%8b%e5%9b%be>#</a></h4><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>+--------+
</span></span><span style=display:flex><span>| start  |
</span></span><span style=display:flex><span>+--------+
</span></span><span style=display:flex><span>    |
</span></span><span style=display:flex><span>    |
</span></span><span style=display:flex><span>    v
</span></span><span style=display:flex><span>+--------+  否
</span></span><span style=display:flex><span>| 触发   |------------+
</span></span><span style=display:flex><span>+--------+            |
</span></span><span style=display:flex><span>  是|                 |
</span></span><span style=display:flex><span>    |                 |
</span></span><span style=display:flex><span>    v                 |
</span></span><span style=display:flex><span>+--------+  否        |
</span></span><span style=display:flex><span>|  完成  | -----+     |
</span></span><span style=display:flex><span>+--------+      |     |
</span></span><span style=display:flex><span>    |           |     |
</span></span><span style=display:flex><span> 是 |           |     |
</span></span><span style=display:flex><span>    v           |     |
</span></span><span style=display:flex><span>+--------+      |     |
</span></span><span style=display:flex><span>| updata | &lt;----+     |
</span></span><span style=display:flex><span>+--------+            |
</span></span><span style=display:flex><span>    |                 |
</span></span><span style=display:flex><span>+---v----+            |
</span></span><span style=display:flex><span>| end    | &lt;----------+
</span></span><span style=display:flex><span>+--------+</span></span></code></pre></div><ol><li>触发条件判断<br><ul><li>时间start - end范围<br></li><li>特定kind, 特定room_level下的任务.<br>比如完成斗地主高级场一次<br></li><li>用户身份的限定<br>比如vip才可完成的任务<br></li></ul></li><li>完成条件的判断<br><ol><li>需要先根据周期重置来重置任务完成状况<br></li><li>任务完成状况与task配置中的任务step_all比较, 判断是否完成<br></li></ol></li><li>update<br>更新任务完成状况<br></li></ol><h4 id=配置文件-and-and-中间状态>配置文件 && 中间状态<a class=anchor href=#%e9%85%8d%e7%bd%ae%e6%96%87%e4%bb%b6-and-and-%e4%b8%ad%e9%97%b4%e7%8a%b6%e6%80%81>#</a></h4><p><strong>配置文件放到database task表</strong><br></p><table><thead><tr><th>名称</th><th>描述</th><th>类型</th><th>优先级</th><th>开始时间</th><th>结束时间</th><th>重置周期</th><th>其他触发限制</th><th>总步数</th><th>奖励配置</th></tr></thead><tbody><tr><td>name</td><td>desc</td><td>type</td><td>priority</td><td>start_time</td><td>end_time</td><td>reset_period</td><td>on_xml</td><td>step_all</td><td>award</td></tr></tbody></table><p>type解释,<br>斗地主初级场1次, 斗地主初级场2次, 斗地主初级场3次<br>那么他们的type可以一致, 并设置priority分别为1,2,3<br>这样就可以认为这三个任务是阶段性任务. 先完成斗地主初级场1次后, 才会显示斗地主初级场2次;<br>完成斗地主初级场2次后,才会显示斗地主初级场3次. 形成一个阶段<br></p><p>所以type相同, 认为是同一种类型任务(触发流程, 完成流程都一致), 而priority可以区分其阶段.<br></p><p><strong>中间状态放到redis task_status_$uid_$taskid表</strong><br></p><table><thead><tr><th>uid</th><th>任务id</th><th>当前步数</th><th>任务完成时间</th><th>任务状态</th></tr></thead><tbody><tr><td>uid</td><td>taskid</td><td>step_current</td><td>time</td><td>status</td></tr></tbody></table><p>time应该是任务完成的时间. 昨天完成的时间, 到了今天也会重置<br>status 0 未完成, 1完成未领奖, 2完成已领奖<br></p><h4 id=任务类的设计>任务类的设计<a class=anchor href=#%e4%bb%bb%e5%8a%a1%e7%b1%bb%e7%9a%84%e8%ae%be%e8%ae%a1>#</a></h4><ol><li>Task<br><ul><li>tagTask 任务配置的数据结构<br></li><li>触发逻辑判断 task::bOn(&mldr;) 入参可能较多<br></li><li>完成逻辑判断 task::bComplete(tagTaskStatus)<br></li></ul></li><li>TaskManager<br><ul><li>map&lt;taskid, Task><br></li><li>更新逻辑 TaskManager::updata()<br></li><li>获取不同mtype(或sub_type)的任务<br></li><li>增加, 删除任务<br></li></ul></li></ol></article><footer class=book-footer><div class="flex flex-wrap justify-between"><div></div><div></div></div><div class="flex flex-wrap justify-between"><span><a href=/blog/docs/server/redis/ class="flex align-center"><img src=/blog/icons/backward.svg class=book-icon alt=Previous title=redis>
<span>redis</span>
</a></span><span><a href=/blog/docs/server/db/ class="flex align-center"><span>db</span>
<img src=/blog/icons/forward.svg class=book-icon alt=Next title=db></a></span></div><script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script><div class=book-comments></div></footer><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><a href=#server-gate>server-gate</a><ul><li><a href=#logon>logon</a></li><li><a href=#game>game</a></li><li><a href=#center>center</a></li><li><a href=#server-match><span class="org-todo todo TODO">TODO</span> server–match</a></li><li><a href=#server-rank><span class="org-todo todo TODO">TODO</span> server–rank</a></li><li><a href=#server-task>server&ndash;task</a></li></ul></li></ul></nav></div></aside></main></body></html>