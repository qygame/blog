<!doctype html><html lang=en dir=ltr><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="room server "><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#343a40"><meta name=color-scheme content="light dark"><meta property="og:url" content="https://qygame.github.io/blog/docs/server/room/"><meta property="og:site_name" content="QYGame"><meta property="og:title" content="room"><meta property="og:description" content="room server"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="docs"><meta property="article:published_time" content="2025-10-02T18:06:00+00:00"><meta property="article:modified_time" content="2025-10-23T07:03:43+00:00"><title>room | QYGame</title><link rel=icon href=/blog/favicon.png><link rel=manifest href=/blog/manifest.json><link rel=canonical href=https://qygame.github.io/blog/docs/server/room/><link rel=stylesheet href=/blog/book.min.e456d10aed65d3bbdca94d70c236a8aa850b8de9fd31e4073ed44adec0702035.css integrity="sha256-5FbRCu1l07vcqU1wwjaoqoULjen9MeQHPtRK3sBwIDU=" crossorigin=anonymous><script defer src=/blog/fuse.min.js></script><script defer src=/blog/en.search.min.4e9e96ab89994a124f9ec80ad56902f75f4159942a97879de89a9ea6721a1000.js integrity="sha256-Tp6Wq4mZShJPnsgK1WkC919BWZQql4ed6JqepnIaEAA=" crossorigin=anonymous></script></head><body dir=ltr class="book-kind-page book-type-docs"><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/blog/><span>QYGame</span></a></h2><div class="book-search hidden"><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><script>document.querySelector(".book-search").classList.remove("hidden")</script><ul><li><input type=checkbox id=section-d15f507e6e1a7624bc54d6a8a1d45016 class=toggle checked>
<label for=section-d15f507e6e1a7624bc54d6a8a1d45016 class=flex><a role=button>server</a>
<img src=/blog/icons/chevron-right.svg class=book-icon></label><ul><li><a href=/blog/docs/server/architecture/>服务器架构</a></li><li><a href=/blog/docs/server/02_message_flow/>消息流向</a></li><li><a href=/blog/docs/server/04_ticket/>门票 Ticket</a></li><li><a href=/blog/docs/server/03_game/>房间配置</a></li><li><a href=/blog/docs/server/server/>约定俗称</a></li><li><a href=/blog/docs/server/gate/>gate</a></li><li><a href=/blog/docs/server/room/ class=active>room</a></li><li><a href=/blog/docs/server/redis/>redis</a></li><li><a href=/blog/docs/server/subgame/>subgame</a></li><li><a href=/blog/docs/server/22/>牌九</a></li></ul></li></ul></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/blog/icons/menu.svg class=book-icon alt=Menu></label><h3>room</h3><label for=toc-control><img src=/blog/icons/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#room-old>room old</a><ul><li><a href=#对外接口>对外接口</a></li><li><a href=#table设计思路>table设计思路</a></li><li><a href=#战绩-and-and-录像回放>战绩 && 录像回放</a></li><li><a href=#小局结束-数据处理>小局结束 数据处理</a></li><li><a href=#玩家动作-坐下-起立-离开-解散-换桌--金币场>玩家动作 坐下|起立|离开|解散|换桌(金币场)</a></li><li><a href=#玩家状态>玩家状态</a></li><li><a href=#椅子视图>椅子视图</a></li><li><a href=#tableid生成方式>tableid生成方式</a></li><li><a href=#房间配置加载>房间配置加载</a></li></ul></li><li><a href=#room-new>room new</a></li></ul></nav></aside></header><article class="markdown book-article"><p>room server<br></p><h2 id=room-old>room old<a class=anchor href=#room-old>#</a></h2><h3 id=对外接口>对外接口<a class=anchor href=#%e5%af%b9%e5%a4%96%e6%8e%a5%e5%8f%a3>#</a></h3><ul><li>GetTable 获取table状态信息<br></li><li>GetTableUser 获取玩家是否在桌子上<br></li><li>EnterTable(uid, tableid) 进入桌子<br></li><li>EnterTable(uid, tagRoomrule) 进入桌子<br></li><li>EnterTable(vector&lt;uid>, tagRoomrule) 进入桌子<br></li></ul><h3 id=table设计思路>table设计思路<a class=anchor href=#table%e8%ae%be%e8%ae%a1%e6%80%9d%e8%b7%af>#</a></h3><p>roomSvr中的table是最基本的table, 不考虑金币场, 比赛场, 俱乐部<br>只处理游戏逻辑<br></p><p>也就是说, 这里Table不区分房卡场, 金币场等<br>对自身影响范围:<br></p><ol><li><input checked disabled type=checkbox> 门票的问题<br>门票无需特意处理, 因为在创建房间之前, 门票就已经算清楚了<br></li><li><input checked disabled type=checkbox> 算分的问题<br>只是把结果放出来, 至于具体如何处理, table可以不需要关心<br></li></ol><h3 id=战绩-and-and-录像回放>战绩 && 录像回放<a class=anchor href=#%e6%88%98%e7%bb%a9-and-and-%e5%bd%95%e5%83%8f%e5%9b%9e%e6%94%be>#</a></h3><h4 id=查询>查询<a class=anchor href=#%e6%9f%a5%e8%af%a2>#</a></h4><p>数据存放在database中<br>player_score 战绩-玩家信息<br>table_record 战绩-桌子信息<br>table_video 录像回放<br></p><p>模拟运行:<br></p><ol><li><p>查看大局战绩<br></p><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>player_score与table_record联查, onlyid为连接标志
</span></span><span style=display:flex><span>根据player_score.userid 与 table_record.clubid 找出top 100的onlyid
</span></span><span style=display:flex><span>根据onlyid和curcount=0 在player_score中查找所有符合条件的数据
</span></span><span style=display:flex><span>最后联查player, 联查标记为userid</span></span></code></pre></div></li><li><p>查看小局战绩<br></p><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>根据onlyid 在player_score查找即可
</span></span><span style=display:flex><span>最后联查player, 联查标志位userid</span></span></code></pre></div></li><li><p>查看录像回放<br></p><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>根据onlyid, curcount 在table_video中查找即可</span></span></code></pre></div></li></ol><h4 id=录像回放-写入>录像回放 写入<a class=anchor href=#%e5%bd%95%e5%83%8f%e5%9b%9e%e6%94%be-%e5%86%99%e5%85%a5>#</a></h4><ol><li><p>RoomServer frmae中处理, 子游戏不需要考虑<br></p></li><li><p>frame的SendTable()函数中, 调用录像类记录<br></p></li><li><p>在小局结束的时候, 调用录像类获取数据<br></p><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>这里的数据是proto序列化为string后, 又转为了raw-string, 方便写入数据库</span></span></code></pre></div></li><li><p>数据库读取出raw-string, 转为string, 再转为录像数据table_video结构体<br></p></li><li><p>子游戏只需要解析table_video即可<br></p></li></ol><h3 id=小局结束-数据处理>小局结束 数据处理<a class=anchor href=#%e5%b0%8f%e5%b1%80%e7%bb%93%e6%9d%9f-%e6%95%b0%e6%8d%ae%e5%a4%84%e7%90%86>#</a></h3><ol><li><input checked disabled type=checkbox> 玩家 门票<br></li><li><input checked disabled type=checkbox> 玩家 财富变更<br></li><li><input checked disabled type=checkbox> 玩家 具体输赢情况<br></li><li><input checked disabled type=checkbox> 玩家 任务系统<br></li><li><input checked disabled type=checkbox> 桌子 战绩<br></li><li><input checked disabled type=checkbox> 桌子 回放<br></li></ol><p>财富变更表 &ndash; 比较独立的表格 player_log_treasure<br></p><table><thead><tr><th>玩家id</th><th>财富类型</th><th>财富数量</th><th>备注说明</th><th>插入时间</th></tr></thead><tbody></tbody></table><p>玩家输赢情况表 player_score<br></p><table><thead><tr><th>玩家id</th><th>当前桌子局数</th><th>椅子位置</th><th>分数</th><th>大赢家标志</th><th>唯一标志</th><th>插入时间</th></tr></thead><tbody></tbody></table><p>战绩表 table_record<br></p><table><thead><tr><th>桌子ID</th><th>桌子类型(房卡, 金币)</th><th>总局数</th><th>桌子玩家数</th><th>KindID</th><th>clubid</th><th>子游戏信息</th><th>唯一标志</th><th>插入时间</th></tr></thead><tbody></tbody></table><p>战绩回放表 table_video<br></p><table><thead><tr><th>当前桌子局数</th><th>回放数据</th><th>唯一标志</th><th>插入时间</th></tr></thead><tbody></tbody></table><p>备注说明:<br></p><ol><li>玩家财富变更均通过 玩家财富变更记录表 &ndash; 所有财富类型<br></li><li>战绩表 只 记录桌子信息, 而不记录 玩家输赢信息<br></li></ol><h3 id=玩家动作-坐下-起立-离开-解散-换桌--金币场>玩家动作 坐下|起立|离开|解散|换桌(金币场)<a class=anchor href=#%e7%8e%a9%e5%ae%b6%e5%8a%a8%e4%bd%9c-%e5%9d%90%e4%b8%8b-%e8%b5%b7%e7%ab%8b-%e7%a6%bb%e5%bc%80-%e8%a7%a3%e6%95%a3-%e6%8d%a2%e6%a1%8c--%e9%87%91%e5%b8%81%e5%9c%ba>#</a></h3><p>玩家加入<br>玩家坐下<br>玩家起立<br>玩家离开<br>金币换桌<br></p><h4 id=旁观的处理>旁观的处理<a class=anchor href=#%e6%97%81%e8%a7%82%e7%9a%84%e5%a4%84%e7%90%86>#</a></h4><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>是否旁观是由服务器根据桌子状态来判断的</span></span></code></pre></div><p>玩家加入房间的时候<br>如果房间已经开始&&允许旁观, 则可以设置为旁观状态<br>如果房间没有开始, 则是坐下状态<br></p><h3 id=玩家状态>玩家状态<a class=anchor href=#%e7%8e%a9%e5%ae%b6%e7%8a%b6%e6%80%81>#</a></h3><p>状态1 UserStatusL<br>状态2 UserStatusH<br></p><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>两者非互斥关系, UsetStatusL内部为互斥关系, UserStatusH内部为互斥关系
</span></span><span style=display:flex><span>掉线之后未必为托管状态, 掉线8s之后, 将由掉线状态变为托管状态; 当掉线回来后, 托管状态自动取消</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>//用户状态 low
</span></span><span style=display:flex><span>enum UserStatusL
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>   FREE_L=0;      //没有状态
</span></span><span style=display:flex><span>   SIT = 1;       //坐下
</span></span><span style=display:flex><span>   STANDUP =2;    //站立(旁观)
</span></span><span style=display:flex><span>   READY= 3;      //准备状态
</span></span><span style=display:flex><span>   PLAYING=4;     //游戏中
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>//用户状态 high 与low不互斥
</span></span><span style=display:flex><span>enum UserStatusH
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>   FREE_H =0;     //正常状态
</span></span><span style=display:flex><span>   TUOGUAN =1;    //托管
</span></span><span style=display:flex><span>   OFFLINE=2;     //掉线 -- 掉线8s之后设置为托管状态
</span></span><span style=display:flex><span>};</span></span></code></pre></div><h3 id=椅子视图>椅子视图<a class=anchor href=#%e6%a4%85%e5%ad%90%e8%a7%86%e5%9b%be>#</a></h3><p>唯一视图 真实的椅子位置<br>frame: m_player_list与真实椅子视图 是通过CPlayer来转换的<br>subgame: subgame实现了真实的椅子视图<br>client: client存在C视图 与 真实椅子视图(S视图)的转换<br></p><h3 id=tableid生成方式>tableid生成方式<a class=anchor href=#tableid%e7%94%9f%e6%88%90%e6%96%b9%e5%bc%8f>#</a></h3><p>table 由redis启动的时候预先生成100000-999999<br>table_using使用zset记录tableid, 创建time. 后面删除的时候, 根据time来有选择的删除,<br>比如删除5分钟之前的桌子, 提高效率.<br></p><h3 id=房间配置加载>房间配置加载<a class=anchor href=#%e6%88%bf%e9%97%b4%e9%85%8d%e7%bd%ae%e5%8a%a0%e8%bd%bd>#</a></h3><p>加载子游戏的fk, gold, match信息<br></p><h4 id=配置文件>配置文件<a class=anchor href=#%e9%85%8d%e7%bd%ae%e6%96%87%e4%bb%b6>#</a></h4><p>配置文件放在<br>kindid/cfg/kindid.fk<br>kindid/cfg/kindid.gold<br>kindid/cfg/kindid.match<br></p><h4 id=房间规则配置>房间规则配置<a class=anchor href=#%e6%88%bf%e9%97%b4%e8%a7%84%e5%88%99%e9%85%8d%e7%bd%ae>#</a></h4><ul><li><p>房间规则分析</p><p><strong>房间规则由来</strong><br>对于每一个具体的游戏来讲, 游戏本身是规则下的流程<br>这里的规则分为两大类<br>一类是游戏自身的规则, 比如斗地主需要一副牌, 有三带一等各种牌型.<br>这种规则本身变化不大, 影响的是游戏自身的流程.<br>还有一类规则是影响游戏逻辑之外的, 比如3小局, 4小局. 比如这是房卡场的, 金币场的等等<br></p><p>于是我们把所有游戏共用的规则(主要是第二类规则), 提取出来放到tagRoomRuleCom<br>而对于每个子游戏不同的游戏规则, 我们只需要提供map&lt;key, choose_index>给子游戏即可<br></p><p>房间规则不区分游戏玩法.<br>房卡场, 金币场, 比赛场, 俱乐部玩法的房间规则使用同一个结构体tagRoomRule<br>通用房间规则 是指抽象出来供frame使用的, 使用统一结构体tagRoomRuleCom<br>子游戏规则 是每个子游戏自身的规则, 在frame层以map&lt;key, choose_index>的形式传递给子游戏, 由子游戏自己解析<br></p><p><strong>房间规则继续分析</strong><br>无论对于tagRoomRuleCom 还是map&lt;key, choose_index> 都可以认为是key, value的键值对<br>所以我们配置文件, 可以采取最基本的key, value形式.<br>但是考虑到房卡场, 金币场等具体玩法, 我们期待的金币场也可以配置自身的游戏规则.<br>比如初级场可以配置为3小局, 底分2; 中级场可以配置为2小局, 底分5;<br>因此可以再进一步抽象为<br></p><ol><li>先提供一个可供选择的规则配置<br></li><li>需要什么样的规则, 只要提供对应的choose, 就可以生成具体的tagRoomRule<br></li></ol></li></ul><ul><li><p>房间规则配置</p><p><strong>目标</strong><br></p><ol><li>金币场, 比赛场, 俱乐部模式 更好的配置游戏规则<br></li><li>对于房卡场, 服务器控制client的房间规则显示<br>client开发的时候 不需要做任何处理<br></li></ol><p><strong>client使用流程</strong><br></p><ol><li><p>client申请创建房间<br></p></li><li><p>server判断是否符合创建条件, 发送房间规则配置 rule_arry(在STR_Game.proto中)<br>其中css控制client显示的样式<br>rule表示一条规则<br></p><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>css
</span></span><span style=display:flex><span>1
</span></span><span style=display:flex><span>2
</span></span><span style=display:flex><span>特殊规则 3, 4, 5
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>rule_1  人数
</span></span><span style=display:flex><span>rule_2  局数
</span></span><span style=display:flex><span>rule_3  炸弹
</span></span><span style=display:flex><span>rule_4  鬼子
</span></span><span style=display:flex><span>rule_5  天王九</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>人    数   &#34;2&#34; &#34;3&#34; &#34;4&#34;
</span></span><span style=display:flex><span>局    数   &#34;2&#34; &#34;3&#34; &#34;4&#34;
</span></span><span style=display:flex><span>特殊规则   炸弹o  鬼子o 天王九o</span></span></code></pre></div></li><li><p>client返回 选择结果 repeated int32<br>比如: 上面选择了 2人 4局, 则返回<br>0<br>2<br>每个返回字段为byte, 返回的value index<br></p></li><li><p>server收到后, 构造房间规则tagRoomRule<br></p></li></ol><p><strong>其他游戏模式使用流程</strong><br>对于金币场,比赛场等使用更加简单, 直接提供choose_values即可<br></p></li></ul><h2 id=room-new>room new<a class=anchor href=#room-new>#</a></h2><p>其中room模块是最容易出错的，继续细分<br></p><ol><li>EnterTable 校验和处理<br></li><li>在table中的处理<br></li><li>LevealTable<br></li></ol><p>上面的有点糙，先不管，继续整理出来思路<br></p><p>table的概念设计 类比真实的 桌子<br>玩家找到一个空闲的桌子，<br>在桌子上找一个空闲椅子<br>在椅子上坐下<br>表示准备好了<br>等所有人准备好了，开始游戏<br></p><p>玩家和椅子：<br>sit，up，ready<br></p><p>玩家和table<br>enter，leave<br></p><p>enter table，但没有sit on chair就表示旁观<br></p><p>table自身拆分为一系列小的组合. 比如游戏结束的处理就专门给sub_gameend.<br>table 只负责流程， 具体处理扔给后面的handler<br></p><p>ready 要不要是与椅子的交互呢？<br>table肯定是enter和leave 两种动作<br>chair肯定也有sit和up<br>如果ready不是与椅子的交互，又是什么呢？<br></p><p>玩家状态in table<br>free - 刚刚Enter table<br>sit — sit on chair<br>ready — ready action<br>playing — 游戏开始了<br></p><p>table状态：<br>free - 游戏未开始<br>playing - 游戏开始了<br>xj end 小局结束了<br>dj end 大局结束了<br></p></article><footer class=book-footer><div class="flex flex-wrap justify-between"><div></div><div></div></div><div class="flex flex-wrap justify-between"><span><a href=/blog/docs/server/gate/ class="flex align-center"><img src=/blog/icons/backward.svg class=book-icon alt=Previous title=gate>
<span>gate</span>
</a></span><span><a href=/blog/docs/server/redis/ class="flex align-center"><span>redis</span>
<img src=/blog/icons/forward.svg class=book-icon alt=Next title=redis></a></span></div><script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script><div class=book-comments></div></footer><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><a href=#room-old>room old</a><ul><li><a href=#对外接口>对外接口</a></li><li><a href=#table设计思路>table设计思路</a></li><li><a href=#战绩-and-and-录像回放>战绩 && 录像回放</a></li><li><a href=#小局结束-数据处理>小局结束 数据处理</a></li><li><a href=#玩家动作-坐下-起立-离开-解散-换桌--金币场>玩家动作 坐下|起立|离开|解散|换桌(金币场)</a></li><li><a href=#玩家状态>玩家状态</a></li><li><a href=#椅子视图>椅子视图</a></li><li><a href=#tableid生成方式>tableid生成方式</a></li><li><a href=#房间配置加载>房间配置加载</a></li></ul></li><li><a href=#room-new>room new</a></li></ul></nav></div></aside></main></body></html>